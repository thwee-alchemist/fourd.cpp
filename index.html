<!DOCTYPE html>
<html>
    <head>
      <meta charset="utf-8">
      <title>fourd.wasm</title>
      <meta author="joshua.moore@leudla.net">
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
      <link rel="stylesheet" href="/bootstrap-slider.min.css">
      <link rel="stylesheet" href="fourd.css">
      <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
      <script src="/bootstrap-slider.min.js"></script>
    </head>
    <body>
      <h2>fourd.wasm</h2>
      <p>fourd.wasm is a rewrite of <a href="https://github.com/thwee-alchemist/FourDSocketProxy/blob/master/lib/fourd.js">fourd.js</a> in <a href="https://github.com/thwee-alchemist/fourd.cpp/blob/gh-pages/fourd.cpp">C++</a>, compiled to web assembly.</p>
      <p> Eventually this work will flow into <a href="https://www.npmjs.com/package/fourdsocketproxy">fourdsocketproxy</a></p>
      <p>To see this animation in action: 
        <ol>
          <li>Click +v twice.</li>
          <li>Click +e once</li>
          <li>Enter 0 (zero) when prompted for the edge's source.</li>
          <li>Enter 1 (one) when prompted for the edge's target.</li>
          <li>Carefully play with the values below. (The fourd.graph.settings object lets you set these values via the console.)</li>
          <li>When it breaks, hit refresh</li>
          <li class="warning">This animation may cause seizures!</li>
        </ol>

      </p>
      <div class="container well">
        <span class="col-md-6">
            <div class="display"></div>
        </span>
          
        <div class="col-md-6">
          <button 
            class="btn btn-primary" 
            onclick="fourd.graph.add_vertex(options);">
            +v
          </button>
          
          <button 
            class="btn btn-primary" 
            onclick="fourd.graph.add_edge(graph.V.get(parseInt(prompt('Source?'))), graph.V.get(parseInt(prompt('Target?'))), {color: 0xffffff, strength: 1.0});">
            +e
          </button>

          <button
            class="btn btn-primary"
            onclick="makeCube(fourd, parseInt(prompt('How big a cube do you want? Try 3')));">
            +cube
          </button>
        </div>

        <div class="well col-md-6">
          <form oninput="
            ">
          <label class="lbl form-label" for="repulsion">Repulsion</label>
          <output 
            id="repulsion-output"
            name="repulsion"
            value="fourd.graph.settings.repulsion">
            </output><br>
          <input 
            id="repulsion-input"
            class="range text" 
            id="repulsion">
            <br> 

          <label class="lbl form-label" for="attraction">Attraction: </label>
          <output
            id="attraction-output"
            name="attraction"
            value="fourd.graph.settings.attraction"">
            </output><br>
          <input 
            id="attraction-input"
            class="range">
            <br>

          <label class="lbl form-label" for="epsilon">Epsilon: </label>
          <output
            id="epsilon-output"
            name="epsilon"
            value="fourd.graph.settings.epsilon">
            </output><br>
          <input 
            id="epsilon-input"
            class="range" 
            step="1">
            <br>

          <label class="lbl form-label" for="friction">Friction</label>
          <output
            id="friction-output"
            name="friction">
            </output><br>
          <input
            id="friction-input"
            class="range">
            <br>

          <label class="lbl form-label" for="inner_distance">Inner Distance</label>
          <output
            id="inner-distance-output"
            name="inner_distance"
            value="fourd.graph.settings.inner_distance"">
            </output><br>
          <input 
            id="inner-distance-input"
            class="range"><br>
          </form>
        </div>
      </div>
      <script src="r103.three.min.js"></script>
      <script src="OrbitControls.js"></script>
      <script src="fourd.js"></script>
      <script src="jquery-1.11.3.min.js"></script>
      <script src="animation.js"></script>

      <script>
var makeCube = async function(fourd, SIZE){
  var depths = [];
  for(var k=0; k<SIZE; k++){
    var rows = [];
    for(var i=0; i<SIZE; i++){
      var column = [];
      for(var j=0; j<SIZE; j++){
        var some = new Promise((resolve, reject) => {
          setTimeout(function(){
            resolve(true)
          }, 500);
        })
        await some;
        column.push(fourd.graph.add_vertex(options));
        if(j>0){
            fourd.graph.add_edge(column[j], column[j-1], false, 1.0);
        }
        if(i>0){
            fourd.graph.add_edge(column[j], rows[i-1][j], false, 1.0);
        }
        if(k>0){
            fourd.graph.add_edge(column[j], depths[k-1][i][j], false, 1.0);
        }
      }
      rows.push(column);
    }
    depths.push(rows);

  }
}

Module.onRuntimeInitialized = _ => {

  fourd = new FourD(
    document.querySelector('.display'), 
    {
      border: '1px solid black',
      width: 500,
      height: 250,
      background: 0x004477
    }, 
    Module.default_settings,
    Module.LayoutGraph
  );

  options = {cube: {size: 0, color: 0x000000}};

  fourd.graph.settings.repulsion = 1e2;
  fourd.graph.settings.attraction = 1e-3;
  fourd.graph.settings.epsilon = 0.0001;
  fourd.graph.settings.inner_distance = 3.6;

  var range = function(min, max, step){
    var r = [];
    for(var i=min; i<max; i += step){
      r.push(i);
    }
    return r;
  }

  var bindIO = function(inputSel, outputSel, variable){
    console.log(inputSel);
    new Slider(inputSel, {
      ticks: range(-5, 4, 1),
      ticks_labels: range(-5, 4, 1).map(v => `10^${v}`),
      ticks_snap_bounds: 10,
      value: variable/10
    })
    $(inputSel)[0].value = variable/10;
    
    $(inputSel).change(() => {
      var value = 10^($(inputSel).val());
      variable = value;
      $(outputSel)[0].value = variable;
    });

    $(outputSel)[0].value = variable;
  };

  bindIO('#repulsion-input', '#repulsion-output', fourd.graph.settings.repulsion);
  bindIO('#attraction-input', '#attraction-output', fourd.graph.settings.attraction);
  bindIO('#friction-input', '#friction-output', fourd.graph.settings.friction);
  bindIO('#epsilon-input', '#epsilon-output', fourd.graph.settings.epsilon);
  bindIO('#inner-distance-input', '#inner-distance-output', fourd.graph.settings.inner_distance);

  console.log(graph.vertex_count);
};
        </script>
    </body>
</html>